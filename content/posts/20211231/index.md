---
title: "『ゼロからのOS自作入門』を読んでMikanOSを改造してみた"
date: 2021-12-31T12:08:00+09:00
draft: false
tags: ["本", "operating system", "MikanOS", "kinOS"]
slug: "read-zero-os-dev"
---

# はじめに

[『ゼロからの OS 自作入門』内田公太(2021)](https://www.amazon.co.jp/%E3%82%BC%E3%83%AD%E3%81%8B%E3%82%89%E3%81%AEOS%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80-%E5%86%85%E7%94%B0-%E5%85%AC%E5%A4%AA/dp/4839975868)を一通り読んだので、この本で作る[MikanOS](https://github.com/uchan-nos/mikanos)を自分なりに改造してみました。

# 本の感想

まず自分は、この本以前に技術書を読んだ経験がなくコードも大学の課題ぐらいでしか書いたことがなかったので、一通り本を読んでコードを写経し終わったときはとても達成感がありました。

内容は自分にとっては結構難しく感じました。というのも自分は OS どころか低レイヤについても何も知らない状態で読み始めたからだと思います。実際読み切るまでに 3~4 ヶ月ほどかかり、その間に 1 度挫折しています。この本をスムーズに読むには、ある程度低レイヤや OS についての知識があったほうがいいかもしれません。ただ OS を作るにはたくさんの知識が必要ですが、この本はそれらのことについてわかりやすく丁寧に書かれているので全く知識がなかった自分でも時間をかけて理解することができました。

またこの本は OS のことだけではなく、C++の文法やポインタについての解説もあるので、プログラミング経験があまりない自分にとってはプログラミングの勉強にもなりました。

# MikanOS を改造してみた

せっかく読み終わったので、この本で作る MikanOS を改造してみました。OS について調べていく中で、マイクロカーネルという概念を知ったので、MikanOS をそれっぽくしてみたら面白いんじゃないかと思いました。マイクロカーネルについては[Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB)から引用します。

> マイクロカーネル（英: microkernel）とはオペレーティングシステム (OS) の設計思想、及びそのような OS のカーネル部の名称である。OS が担う各種機能のうち、必要最小限のみをカーネル空間に残し、残りをユーザーレベルに移すことで全体の設計が簡素化でき、結果的にカスタマイズ性が向上し、性能も向上できるという OS の設計手法のことである。
>
> 「マイクロカーネル」『フリー百科事典 ウィキペディア日本語版』 最終更新日時 2021 年 8 月 31 日 17:32 UTC アクセス日時 2021 年 12 月 31 日 06:40 UTC URL: https://ja.wikipedia.org

MikanOS はカーネルの中に GUI やファイルシステムがあるので設計としてはモノリシックだと思います。改造するにあたりそのような機能を提供するプログラムをユーザー空間で再実装することを目標にしました。また以下ではそのような OS の一部の機能を提供するユーザー空間でのプログラムをサーバと呼んでいます。

# できたもの

{{<githubcard url="https://github.com/kinpoko/kinOS" name="kinOS">}}

# デモ

{{<img src="screenshot.png" alt="screenshot" title="QEMUで起動させた様子">}}

# kinOS の構成

{{<img src="kinosarchit.drawio.png" alt="architecture" title="構成図">}}

# kinOS のマイクロカーネルっぽいところ

MikanOS ではカーネルの中にあったファイルシステムやターミナル、GUI が、kinOS ではユーザー空間でそれぞれ独立したサーバとして動いています。また open read write といったシステムコールが、kinOS では IPC(プロセス間通信)として実装されています。IPC には MikanOS でも用いられていたメッセージパッシングを少し変えて使っています。

# kinOS のマイクロカーネルっぽくないところ

通常マイクロカーネルのカーネル内には必要最低限の機能しか残さないのですが、気楽にやっているので今の自分の技術ではユーザー空間に切り出すのが難しかった機能(メモリ管理とか USB ドライバなど)はそのまま残してます。結果として厳密な意味でのマイクロカーネルにはなりませんでした。メモリマップドファイルなどの一部の MikanOS にあった機能も難しかったので実装できていません。

# 終わりに

『ゼロからの OS 自作入門』を読んで写経するだけでなく、改造したことで本の内容の理解がより深まったと思います。この本のおかげで低レイヤへの興味が湧いてきたので、しばらく低レイヤについて勉強していきたいと思います。
